{% extends "admin/base_site.html" %}
{% load static admin_urls %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static "admin/css/changelists.css" %}">
<style>
        .report-filter-container {
            padding: 10px 0px; /* Убрал боковые отступы, т.к. module filtered их дает */
        }
        .report-filter-form .filter-form-row { /* Используем свой класс для ряда полей */
            display: flex;
            align-items: center; /* Выравниваем элементы по центру вертикально */
            gap: 10px; /* Пространство между элементами в ряду */
            margin-bottom: 10px;
        }
        .report-filter-form .filter-form-row label {
            margin-right: 5px;
            font-weight: bold;
        }
        /* Пустое правило для select и input[type="submit"] УДАЛЕНО */
        
        .report-results-container {
            margin-top: 20px; /* Отступ перед таблицей результатов */
        }
        .report-results-container h3 { /* Стили для заголовка месяца */
            background: var(--module-header-bg, #79aec8); /* Цвет фона из Django admin (с фолбэком) */
            color: var(--module-header-fg, #fff); /* Цвет текста из Django admin (с фолбэком) */
            padding: 8px 10px;
            font-size: 1em; 
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-list report-page{% endblock %}

{% block content_title %}
    <h1>{{ title }}</h1>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module filtered" id="changelist-filter"> {# Один основной модуль для фильтра и результатов #}
        <h2>Фильтр по дате</h2> {# Упрощенный заголовок #}
        
        <div class="report-filter-container">
            <form method="get" action="" class="report-filter-form">
                <div class="filter-form-row">
                    <label for="{{ form.year.id_for_label }}">{{ form.year.label }}:</label>
                    {{ form.year }}
                    <label for="{{ form.month.id_for_label }}">{{ form.month.label }}:</label>
                    {{ form.month }}
                    <input type="submit" value="Показать отчет">
                </div>
                
                {% if form.errors %}
                    <div class="errornote">
                    {% if form.errors.items|length == 1 %}Пожалуйста, исправьте ошибку ниже.{% else %}Пожалуйста, исправьте ошибки ниже.{% endif %}
                    </div>
                    {{ form.non_field_errors }}
                    {% for field in form %}
                        {% if field.errors %}<div class="errorlist">{{ field.label_tag }}: {{ field.errors|striptags }}</div>{% endif %}
                    {% endfor %}
                {% endif %}
            </form>
        </div>

        {# Результаты отчета теперь внутри того же модуля, после формы #}
        <div class="report-results-container">
            {% if form.is_valid and report_data_grouped %}
                {% for month_year_key, expenses_in_month in report_data_grouped.items %}
                    <h3>Расходы за: {{ month_year_key }}</h3> {# Используем H3 для подзаголовка месяца #}
                    {% if expenses_in_month %}
                        <div class="results"> {# Стандартный класс Django для контейнера таблицы результатов #}
                            <table id="result_list">
                                <thead>
                                    <tr>
                                        <th>Статья расходов</th>
                                        <th style="text-align: right;">Сумма (руб.)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in expenses_in_month %}
                                        <tr class="{% cycle 'row1' 'row2' %}">
                                            <td>{{ item.category }}</td>
                                            <td style="text-align: right;">{{ item.total|floatformat:2 }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p>Нет данных о расходах за {{ month_year_key }}.</p>
                    {% endif %}
                {% endfor %}
            {% elif form.is_valid and not report_data_grouped %}
                <p>Нет данных о расходах за {{ selected_period_display }}.</p>
            {% elif not form.is_valid and request.GET %}
                <p>Пожалуйста, выберите корректный год и месяц.</p>
            {% else %} 
                <p>Выберите год и месяц для формирования отчета.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}