{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .report-table th, .report-table td { border: 1px solid var(--border-color, #ccc); padding: 8px; text-align: left; }
        .report-table th { background-color: var(--table-header-bg, var(--module-bg, #f0f0f0)); color: var(--table-header-fg, var(--header-fg, #333333)); font-weight: bold; }
        .report-table td.amount, .report-table th.amount { text-align: right; }
        
        .totals-summary { 
            margin-top:20px; 
            padding:15px; 
            background-color: var(--module-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
        }
        .totals-summary p { 
            margin: 5px 0; 
            font-size: 1.1em; 
            color: var(--body-fg); 
        }

        .no-data { 
            color: var(--text-muted-color, #666); 
            font-style: italic; 
        }
        .details-toggle { 
            cursor: pointer; 
            color: var(--link-fg); 
            text-decoration: underline; 
            font-size:0.9em; 
            margin-left: 10px; 
        }
        .calculation-details { 
            display: none; 
            margin-left: 20px; 
            border-left: 2px solid var(--hairline-color, #eee); 
            padding-left: 10px; 
            margin-top: 5px; 
        }
        .calculation-details table { 
            font-size:0.9em; 
            width: auto; 
            margin-top:5px; 
        }
        .calculation-details th, 
        .calculation-details td { 
            padding: 4px 6px; 
        }
        .period-navigation { margin-bottom: 20px; text-align: center; }
        .period-navigation a, .period-navigation span { margin: 0 10px; font-size: 1.1em; }
        .period-navigation .current-period { font-weight: bold; }
        .period-form { margin-bottom: 20px; background-color: var(--body-quiet-color, #f5f5f5); padding: 10px; border-radius: 4px; }
        .period-form label { margin-right: 5px;}
        .period-form input[type="number"] { width: 70px; margin-right: 10px; }
         @media (prefers-color-scheme: dark) {
            .period-form { background-color: var(--dark-body-quiet-color, #333); }
        }
    </style>
{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block breadcrumbs %}
    <div class="breadcrumbs">
        <a href="{% url 'admin:index' %}">{% translate 'Home' %}</a> &rsaquo;
        <a href="{% url 'admin:app_list' app_label=app_label %}">Отчеты</a> &rsaquo;
        {{ title }}
    </div>
{% endblock %}

{% block content_title %}<h1>{{ title }}</h1>{% endblock %}

{% block content %}
<div id="content-main">
    {% if messages %}
        <ul class="messagelist">{% for message in messages %}<li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message|capfirst }}</li>{% endfor %}</ul>
    {% endif %}

    <div class="period-form">
        <form method="get" action="{% url 'utils:my_salary_report' %}">
            <label for="id_month">Месяц:</label>
            <input type="number" name="month" id="id_month" value="{{ selected_month }}" min="1" max="12">
            <label for="id_year">Год:</label>
            <input type="number" name="year" id="id_year" value="{{ selected_year }}" min="2020" max="2099">
            <input type="submit" value="Показать отчет">
        </form>
    </div>

    <div class="period-navigation">
        <a href="{{ prev_month_url }}">&laquo; Предыдущий месяц</a>
        <span class="current-period">{{ selected_month|stringformat:"02d" }}.{{ selected_year }}</span>
        {% if next_month_url %}
            <a href="{{ next_month_url }}">Следующий месяц &raquo;</a>
        {% else %}
            <span>Следующий месяц &raquo;</span>
        {% endif %}
    </div>

    <p>Отчет сформирован для сотрудника: <strong>{{ report_user_display }}</strong></p>

    <h2>Начисления</h2>
    {% if salary_calculations %}
        <table class="report-table">
            <thead>
                <tr>
                    <th>ID Расчета (DEBUG)</th>
                    <th>Заказ ID (DEBUG)</th>
                    <th>Сотрудник (DEBUG)</th>
                    <th class="amount">Сумма (DEBUG)</th>
                    <th>Детали (DEBUG)</th>
                </tr>
            </thead>
            <tbody>
                {% for calc in salary_calculations %}
                    <tr>
                        <td>{{ calc.id }}</td>
                        <td>{{ calc.order_id }}</td> 
                        <td>{{ calc.employee.username }}</td>
                        <td class="amount">{{ calc.total_calculated_amount|floatformat:2 }}</td>
                        <td>{% if calc.details.all %}Есть{% else %}Нет{% endif %}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="no-data">Начислений за выбранный период не найдено.</p>
    {% endif %}

    <h2>Выплаты</h2>
    {% if salary_payments %}
        <table class="report-table">
            <thead>
                <tr>
                    <th>ID Выплаты (DEBUG)</th>
                    <th>Сотрудник (DEBUG)</th>
                    <th class="amount">Сумма (DEBUG)</th>
                    <th>Дата (DEBUG)</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in salary_payments %}
                    <tr>
                        <td>{{ payment.id }}</td>
                        <td>{{ payment.employee.username }}</td>
                        <td class="amount">{{ payment.amount_paid|floatformat:2 }}</td>
                        <td>{{ payment.payment_date|date:"d.m.Y" }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="no-data">Выплат за выбранный период не найдено.</p>
    {% endif %}

    <div class="totals-summary">
        <p><strong>Входящий остаток на начало периода ({{ selected_month|stringformat:"02d" }}.{{ selected_year }}):</strong> {{ opening_balance|floatformat:2 }} руб.</p>
        <hr>
        <p><strong>Итого начислено за период:</strong> {{ total_accrued_for_current_period|floatformat:2 }} руб.</p>
        <p><strong>Итого выплачено за период:</strong> {{ total_paid_for_current_period|floatformat:2 }} руб.</p>
        <hr>
        <p><strong>Исходящий остаток на конец периода ({{ selected_month|stringformat:"02d" }}.{{ selected_year }}):</strong> <strong style="font-size:1.2em;">{{ closing_balance|floatformat:2 }} руб.</strong></p>
    </div>
</div>

<script>
// Скрипт для toggleDetails оставляем как есть, он нам еще пригодится
function toggleDetails(elementId) {
    var detailsDiv = document.getElementById(elementId);
    if (detailsDiv) {
        if (detailsDiv.style.display === "none" || detailsDiv.style.display === "") {
            detailsDiv.style.display = "block";
        } else {
            detailsDiv.style.display = "none";
        }
    }
}
document.addEventListener('DOMContentLoaded', function() {
    var detailBlocks = document.querySelectorAll('.calculation-details');
    detailBlocks.forEach(function(block) {
        block.style.display = 'none'; 
    });
});
</script>
{% endblock %}